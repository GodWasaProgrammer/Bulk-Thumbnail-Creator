@page "/picdatalist"
@using BulkThumbnailCreator.PictureObjects
@using BulkThumbnailCreator.Services
@using System.Net.Http.Json
@using System.Net.Http
@using BulkThumbnailCreator
@inject PicDataService PicDataService
@inject JobService js;
@inject Settings settings;
@inject AuthenticationStateProvider AuthProvider;

<MudDataGrid Items="@PicDataList">
    <Columns>
        <PropertyColumn Property="x => x.OutPutType" Title="Type" />
        <PropertyColumn Property=@( x => Path.GetFileNameWithoutExtension(x.FileName)) />
        <PropertyColumn Property="x => x.Varieties.Count" Title="Varieties">
            <CellTemplate>
                <MudButton Size="@Size.Small" Variant="@Variant.Filled" Color="@Color.Primary" OnClick="() => ViewVarieties(context.Item)">View</MudButton>
                @if(view)
                {
                    <MudDataGrid Items="context.Item.Varieties"></MudDataGrid>
                    <PropertyColumn Property="x => x.OutPutType" Title="Type" />
                    <PropertyColumn Property=@( x => Path.GetFileNameWithoutExtension(x.FileName)) />
                }
            </CellTemplate>
        </PropertyColumn>

    </Columns>
</MudDataGrid>

@code
{
    private bool view;
    public void ViewVarieties(PictureData p)
    {
        if(view)
        {
            view = false;
        }
        else
        {
            view = true;
        }
    }

    public Job currentJob;
    public string currentUser;



    IEnumerable<PictureData> PicDataList = new List<PictureData>();

    DataGridFilterMode _filterMode = DataGridFilterMode.Simple;
    DataGridFilterCaseSensitivity _caseSensitivity = DataGridFilterCaseSensitivity.Default;

    protected override async Task OnInitializedAsync()
    {
        var AuthState = await AuthProvider.GetAuthenticationStateAsync();

        currentUser = AuthState.User.Identity.Name;

        if (currentJob == null)
        {
            currentJob = await js.RequestCurrentJob(currentUser);
        }
        await InvokeAsync(() => StateHasChanged());

        if (currentJob is not null)
        {
            PicDataList = currentJob.PictureDatas;
        }
    }
}