@using Bulk_Thumbnail_Creator;
@using Bulk_Thumbnail_Creator.Interfaces;
@using Bulk_Thumbnail_Creator.PictureObjects;
@using MudBlazor.Utilities;
@using UMapx;
@using Bulk_Thumbnail_Creator.Services;
@using WebUI.Components;
@using Bulk_Thumbnail_Creator.Enums;

@inject PicDataService PicDataService
@inject ILogService Logger;
@inject JobService JobService;

<MudPaper>
    <MudGrid>
        <MudItem xs="12" sm="6">
            <PictureDataBox ImageURL="@ImageURL" PicData="@CurrentPagePictureData"></PictureDataBox>
        </MudItem>
        <MudItem xs="12" sm="6">
            <CustomizeBox ImageURL="@ImageURL" CurrentPagePictureData="CurrentPagePictureData" OnCustomBoxHasProducedPicture="SetCustomPicture" @ref="customizeBoxRef" ResetState="ResetState"></CustomizeBox>
        </MudItem>
    </MudGrid>
    <MudButton OnClick="reset">Restart</MudButton>
</MudPaper>

@code
{
    private void reset()
    {
        customizeBoxRef.reset();
        ResetState.DynamicInvoke();
        CurrentJob = JobService.Reset();
        CurrentPagePictureData = null;
        ImageURL = null;
        StateHasChanged();
    }

    CustomizeBox customizeBoxRef;

    [Parameter]
    public Delegate ResetState { get; set; }

    [Parameter]
    public Job CurrentJob { get; set; }

    [Parameter]
    public PictureData CurrentPagePictureData { get; set; }

    [Parameter]
    public string ImageURL { get; set; }

    public void SetCustomPicture(PictureData pictureData, string ImageURLInput)
    {
        CurrentPagePictureData = pictureData;

        ImageURL = ImageURLInput;

        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        if (CurrentJob == null)
        {
            CurrentJob = await JobService.RequestCurrentJob();

            // if we fetched a job lets set the values

            if (CurrentJob != null)
            {
                if (CurrentJob.State == States.CustomPicture)
                {

                }

            }

        }
        else
        {
            if (CurrentJob.State == States.CustomPicture)
            {
                CurrentPagePictureData = PicDataService.SetPictureDataImageDisplayCorrelationForVarietyList(CurrentJob.ClickedImage);
                ImageURL = CurrentJob.ClickedImage;
            }

        }

    }

}