@using Bulk_Thumbnail_Creator.Interfaces;
@using Bulk_Thumbnail_Creator;
@using Bulk_Thumbnail_Creator.Enums;

@inject Bulk_Thumbnail_Creator.Services.PicDataService ds;
@inject ILogService logger;

@if (DisableMenu == false)
{
    <MudContainer MaxWidth="MaxWidth.Small">
        <MudTextField Label="Youtube Link" Variant="Variant.Filled" @bind-Value="textInput" />
        <MudTextField Label="Text To Print 1" Variant="Variant.Filled" @bind-Value="TextToPrint1" />
        <MudTextField Label="Text To Print 2" Variant="Variant.Filled" @bind-Value="TextToPrint2" />
        <MudTextField Label="Text To Print 3" Variant="Variant.Filled" @bind-Value="TextToPrint3" />
        <MudButton OnClick="() => AwaitBTC()" Variant="Variant.Filled" Color="Color.Primary"> <MudText>Run BTC</MudText></MudButton>
    </MudContainer>

    @if (passedNull)
    {
        <MudText>You need to give me an actual YoutubeLink</MudText>
    }

}

@code
{
    private string TextToPrint1 = "Good Ole Rambler try!";
    private string TextToPrint2 = "I've Taken Dunkirk! Onwards Men!";
    private string TextToPrint3 = "Tallyhoo Laddiooo";

    private async Task CallBTC(string url)
    {
        List<string> ListOfTextToPrint = new() { TextToPrint1, TextToPrint2, TextToPrint3 };

        await ds.CreateInitialPictureArrayAsync(url, ListOfTextToPrint);
    }

    private bool DisableMenu;
    private string textInput = string.Empty;
    private bool passedNull = false;

    [Parameter]
    public Action<bool> returnStateUpdate { get; set; }

    [Parameter]
    public Job job { get; set; }

    protected override void OnInitialized()
    {
        if (job != null)
        {
            if (job.State == States.Initial)
            {
                DisableMenu = false;
            }
            else
            {
                DisableMenu = true;
            }

        }
    }

    private async Task AwaitBTC()
    {
        string url = textInput;

        if (url == null || url == string.Empty)
        {
            passedNull = true;
        }
        else
        {
            passedNull = false;
            DisableMenu = true;
            job = await ds.CreateJob(url);

            // should perhaps be called from the job ?
            // like await callbtc(job.url)
            await CallBTC(url);

            returnStateUpdate(DisableMenu);

            await InvokeAsync(() => StateHasChanged());
        }

    }

}